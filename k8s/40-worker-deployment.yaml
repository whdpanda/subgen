apiVersion: apps/v1
kind: Deployment
metadata:
  name: subgen-worker
  namespace: subgen
spec:
  # NOTE: with ReadWriteOnce PVC, keep a single worker replica by default
  # unless all pods are guaranteed to run on the same node or storage supports RWX.
  replicas: 1
  selector:
    matchLabels:
      app: subgen-worker
  template:
    metadata:
      labels:
        app: subgen-worker
    spec:
      # ---- GPU scheduling ----
      # 说明：
      # 1) 下面的 GPU resources 会让 Pod 只能调度到有 nvidia.com/gpu 资源的节点。
      # 2) 若你的 GPU 节点有 taint（常见于运维配置），需要配套 tolerations（见下）。
      #
      # 如果你的集群给 GPU 节点打了特定 label，可取消注释 nodeSelector 并改成你的 label：
      # nodeSelector:
      #   accelerator: nvidia
      #
      # 如果你的 GPU 节点被 taint 了（例如 key=accelerator,value=nvidia,effect=NoSchedule），
      # 需要加 tolerations（按你的实际 taint 修改）：
      # tolerations:
      #   - key: "accelerator"
      #     operator: "Equal"
      #     value: "nvidia"
      #     effect: "NoSchedule"

      containers:
        - name: worker
          # 建议这里用你构建的 GPU 镜像 tag（例如 subgen:pr6-gpu 或你推到 registry 的版本）
          image: subgen:pr6-gpu
          imagePullPolicy: IfNotPresent

          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_UID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.uid
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace

          envFrom:
            - configMapRef:
                name: subgen-config

          # Worker 入口（你已经实现）：python -m subgen.service.rq.worker_main
          command: ["python"]
          args: ["-m", "subgen.service.rq.worker_main"]

          volumeMounts:
            - name: subgen-data
              mountPath: /data

          resources:
            requests:
              cpu: "1000m"
              memory: "1Gi"
              # GPU request（可选；只写 limits 也行，但建议 requests/limits 一致）
              nvidia.com/gpu: "1"
            limits:
              cpu: "2000m"
              memory: "4Gi"
              # GPU limit（关键：没有这个，就不会拿到 GPU）
              nvidia.com/gpu: "1"

      volumes:
        - name: subgen-data
          persistentVolumeClaim:
            claimName: subgen-data